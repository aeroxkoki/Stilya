# Supabase Bad Requestエラーのデバッグガイド

## エラー概要
実機テストで「[Supabase Error]: Bad Request」が発生しています。

## 現在の対応状況

### 実施済みの暫定対応
1. **クエリの簡略化**
   - 複雑な`not.in`や`overlaps`演算子を避ける
   - 基本的なクエリでデータ取得後、アプリケーション側でフィルタリング

2. **エラーハンドリングの強化**
   - 詳細なエラーログ出力
   - エラー時のフォールバック処理

3. **デバッグ情報の追加**
   - クエリパラメータのログ出力
   - エラーの詳細情報表示

## 根本的な解決に必要な確認事項

### 1. エラーの詳細確認
実機でコンソールログを確認し、以下の情報を取得してください：
```
[getPersonalizedRecommendations] Error details: {
  message: "...",
  details: "...",
  hint: "...",
  code: "..."
}
```

### 2. データベーススキーマの確認
Supabaseダッシュボードで確認：
- `external_products`テーブルの構造
- `id`カラムのデータ型（UUID or text）
- `tags`カラムのデータ型（text[] or jsonb）
- `is_active`カラムの存在確認

### 3. RLSポリシーの確認
- `external_products`テーブルのRLS設定
- SELECTポリシーの内容
- 認証なしでのアクセス許可設定

### 4. デバッグスクリプトの実行
```bash
# デバッグスクリプトの実行
cd /Users/koki_air/Documents/GitHub/Stilya
node scripts/debug-supabase-query.js
```

このスクリプトは以下をテストします：
- 基本的なクエリ
- not演算子の動作
- overlaps/contains演算子の動作
- テーブル構造の確認
- RLSポリシーの影響

## 推奨される次のステップ

1. **実機でのエラー詳細確認**
   - アプリを実行し、エラーログの詳細を確認
   - 特に`error.details`と`error.hint`に注目

2. **Supabaseダッシュボードでの確認**
   - SQLエディタで直接クエリを実行
   - RLSポリシーの一時的な無効化テスト

3. **段階的なクエリテスト**
   - まず最もシンプルなクエリから
   - 徐々に条件を追加して問題の箇所を特定

## 既知の問題と解決策

### 問題1: UUID形式の不一致
- 原因: UUIDの大文字小文字の違い
- 解決: データベース側で`lower(id)`を使用

### 問題2: 配列演算子の構文
- 原因: Supabase JS clientのバージョンによる違い
- 解決: 最新バージョンへのアップデート

### 問題3: RLSポリシーの制限
- 原因: 認証なしでのアクセス制限
- 解決: anon roleへの適切な権限付与

## 連絡先
問題が解決しない場合は、以下の情報と共に報告してください：
- エラーログの完全な内容
- Supabaseのバージョン情報
- テーブル構造のスクリーンショット
