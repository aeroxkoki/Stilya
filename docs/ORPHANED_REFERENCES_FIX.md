# 孤立したデータ参照のクリーンアップガイド

## 概要
本ドキュメントは、データベース内の孤立した参照（存在しない商品を参照するレコード）を解決するための対策について説明します。

## 問題の背景
- `favorites`、`swipes`、`click_logs`、`saved_items`テーブルが`external_products`テーブルの商品IDを参照
- 商品が削除されたり、データベースがクリーンアップされた場合、孤立した参照が発生
- これにより、商品詳細取得時に`PGRST116`エラーが繰り返し発生

## 実装した解決策

### 1. ProductServiceの改善（productService.ts）
- `fetchProductById`関数で`.single()`の代わりに`.maybeSingle()`を使用
- 商品が見つからない場合は、エラーレベルではなくwarningレベルでログ出力
- 空のIDや無効なIDに対する早期検証

### 2. ProductStoreの改善（productStore.ts）
- お気に入りとスワイプ履歴の取得時に、存在しない商品を適切にスキップ
- バッチ処理による効率的な商品取得（10件ずつ）
- エラーハンドリングの強化

### 3. クリーンアップスクリプト（cleanup-orphaned-references.js）
孤立した参照を削除するためのスクリプトを作成：

```bash
# 実行方法
cd scripts
node cleanup-orphaned-references.js
```

このスクリプトは以下を実行します：
- 有効な商品IDの取得
- 各テーブルから孤立した参照の検出
- 孤立した参照の削除

## 予防策
1. 商品削除時は、関連するレコードも同時に削除（カスケード削除）
2. 定期的なデータ整合性チェック
3. 外部キー制約の適切な設定

## メリット
- エラーログの削減
- アプリケーションのパフォーマンス向上
- ユーザー体験の改善（エラーを見せない）

## 注意事項
- クリーンアップスクリプトを実行する前に、必ずデータベースのバックアップを取得してください
- 本番環境での実行時は、営業時間外やメンテナンス時間帯に行うことを推奨
