# スワイプ画面パフォーマンス改善レポート

## 実施日時
2025年1月14日

## 問題の内容
スワイプ画面で商品をスワイプした際、前の商品画像が次の画像に一瞬表示される現象が発生していました。これによりユーザー体験が悪化していました。

## 原因分析
1. **コンポーネントのkey問題**: カードスタックで商品IDをkeyとして使用していたため、商品が変わるたびに新しいコンポーネントインスタンスが作成され、画像の切り替えに遅延が発生
2. **画像トランジション時間**: 画像のフェード効果が長すぎて（200ms）、切り替えが視覚的に遅い
3. **プリロード効率**: 必要以上の画像（5枚）をプリロードしており、処理が重い
4. **プリロード間隔**: プリロード処理の間隔が長く（100ms）、画像の準備が遅い

## 実施した改善内容

### 1. カードスタックのkey最適化
```tsx
// 変更前：商品IDベースのkey
key={product.id}

// 変更後：位置ベースのkey
key={\`stack-\${stackIndex}\`}
```
- コンポーネントの再利用を促進し、不要な再レンダリングを防止

### 2. 画像トランジション時間の短縮
```tsx
// 変更前
transition={silentFallback ? 100 : 200}

// 変更後
transition={50}
```
- 画像の切り替えを高速化し、視覚的な遅延を最小化

### 3. プリロード数の最適化
```tsx
// 変更前：5枚先読み
imagePreloadService.preloadProductImages(products, currentIndex + 1, 5)

// 変更後：3枚先読み（実際に表示される分だけ）
imagePreloadService.preloadProductImages(products, currentIndex + 1, 3)
```
- 必要最小限の画像のみプリロードすることで効率化

### 4. プリロード間隔の短縮
```tsx
// 変更前
await new Promise(resolve => setTimeout(resolve, 100));

// 変更後
await new Promise(resolve => setTimeout(resolve, 30));
```
- プリロード処理を高速化

## 修正ファイル
1. \`/src/components/swipe/StyledSwipeContainer.tsx\`
   - カードスタックのkey変更
   - プリロード数の最適化

2. \`/src/components/common/CachedImage.tsx\`
   - 画像トランジション時間の短縮

3. \`/src/services/imagePreloadService.ts\`
   - プリロード間隔の短縮

## 期待される効果
- スワイプ時の画像切り替えがスムーズになる
- 前の画像が一瞬表示される問題が解消
- 全体的なパフォーマンスの向上
- ユーザー体験の改善

## テスト項目
1. スワイプ操作時の画像切り替えの滑らかさ
2. 画像のプリロードが正常に動作すること
3. メモリ使用量が適切であること
4. ネットワークの負荷が適切であること

## 今後の改善案
- 画像キャッシュ戦略のさらなる最適化
- ジェスチャーアニメーションの改善
- 画像サイズの動的調整による最適化
