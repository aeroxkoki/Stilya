# MVPフィルタリング改善ガイド

## 概要

Stilyaアプリのコンセプトに合わない商品（靴下、着物、男性服、小物など）を自動的に除外するフィルタリング機能を実装しました。このガイドでは、その仕組みと使用方法について説明します。

## 主な機能

### 1. NGキーワードフィルタリング

以下のカテゴリの商品を自動的に除外します：

- **性別**: メンズ、男性用、紳士、MEN、men's、ユニセックス
- **不適切カテゴリ**: 
  - 靴下、ソックス、タイツ、ストッキング、レギンス
  - 着物、和服、浴衣、帯、和装、振袖、袴
  - 下着、ショーツ、ブラジャー、インナー、ランジェリー、パンティ
  - ルームウェア、パジャマ、寝巻き、ナイトウェア
- **小物・アクセサリー**: ベルト、手袋、マフラー、ストール、スカーフ、ハンカチ、ネクタイ
- **その他**: キッズ、子供、ベビー、マタニティ、コスプレ、水着、制服、福袋、中古品

### 2. 価格フィルタリング

- 最低価格: 1,500円（デフォルト）
- 最高価格: 50,000円
- 1,500円未満の商品は自動的に除外（靴下などの小物を排除）

### 3. カテゴリ別商品数制限

```
- ワンピース: 5,000件
- トップス: 8,000件
- ボトムス: 4,000件
- アウター: 3,000件
- その他: 2,000件
```

### 4. 優先カテゴリシステム

以下のカテゴリを含む商品を優先的に取得：
- ワンピース、ドレス
- ブラウス、シャツ、トップス
- ニット、セーター、カーディガン
- スカート、パンツ、デニム
- コート、ジャケット、アウター

### 5. 自動クリーンアップ

- 14日以上更新されていない商品を自動削除
- NGキーワードを含む既存商品を削除
- カテゴリ制限を超えた場合、古い商品から自動削除

## 環境変数設定

`.env`ファイルに以下の設定を追加できます：

```bash
# NGキーワードフィルタリングを有効化（デフォルト: true）
ENABLE_NG_FILTER=true

# 最低価格フィルタ（デフォルト: 1500円）
MIN_PRICE_FILTER=1500

# 1回の同期での最大商品数（デフォルト: 1000）
MAX_PRODUCTS_PER_SYNC=1000

# 古い商品の自動削除を有効化（デフォルト: true）
AUTO_DELETE_OLD_PRODUCTS=true

# 古い商品とみなす日数（デフォルト: 14日）
OLD_PRODUCT_DAYS=14
```

## 実行レポート

同期実行後、以下の統計情報が表示されます：

### 全体統計
- 取得商品数
- フィルタ除外数（NGキーワード、価格フィルタ別）
- 保存商品数

### カテゴリ別統計
- 各カテゴリの商品数
- 「その他」カテゴリの割合（30%超えると警告）

### ブランド別統計
- 各ブランドの取得/保存商品数
- 除外率

### 最適化提案
- NGキーワードフィルタの効果分析
- カテゴリバランスのチェック
- 改善推奨事項

## ローカルテスト

ローカルでフィルタリング機能をテストする場合：

```bash
# ドライランモード（DBへの変更なし）
DRY_RUN=true SYNC_MODE=test node scripts/sync/unified-phase3-sync-hq-filtered.js

# 特定ブランドのみテスト
TARGET_BRANDS="UNIQLO,GU" node scripts/sync/unified-phase3-sync-hq-filtered.js

# NGフィルタを無効化してテスト
ENABLE_NG_FILTER=false node scripts/sync/unified-phase3-sync-hq-filtered.js
```

## GitHub Actions実行

GitHub Actionsから手動実行する場合：

1. GitHubリポジトリの「Actions」タブを開く
2. 「Product Sync」ワークフローを選択
3. 「Run workflow」をクリック
4. 必要に応じてオプションを設定
5. 「Run workflow」を再度クリック

## 効果測定

フィルタリング実装により期待される効果：

- **品質向上**: アプリのコンセプトに合った商品のみを表示
- **ユーザー体験向上**: 不要な商品でスワイプが中断されない
- **データベース最適化**: 不要な商品を削除し、容量を節約
- **パフォーマンス向上**: 適切なカテゴリバランスによる表示速度改善

## トラブルシューティング

### NGキーワードフィルタで除外率が高すぎる場合
- 検索キーワードの見直し
- ブランド固有のキーワード追加
- 特定のNGキーワードの除外

### カテゴリ「その他」が多すぎる場合
- カテゴリ判定ロジックの改善
- 新しいカテゴリキーワードの追加

### 商品数が少なすぎる場合
- 最低価格フィルタの調整
- NGキーワードリストの見直し
- ブランドごとの商品数上限の調整

## 今後の拡張予定

1. **機械学習による商品分類**
   - 画像認識によるカテゴリ自動判定
   - より精度の高いフィルタリング

2. **ユーザーフィードバックの活用**
   - スワイプデータから不人気カテゴリを特定
   - 自動的にフィルタリングルールを更新

3. **季節別フィルタリング**
   - 季節に応じた商品の自動選別
   - 季節外れ商品の自動除外

4. **ブランド別カスタムルール**
   - ブランドごとの特性に応じたフィルタリング
   - より精緻な商品選別
