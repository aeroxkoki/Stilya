# データベース構造確認結果サンプル

## 実行情報
- 実行日時: [実行日時を記入]
- 実行者: [実行者名]
- Supabase Project: Stilya Production
- 実行方法: Supabase SQL Editor

## 1. external_products テーブル

### 1.1 プライマリキー
- **プライマリキーカラム**: `id` または `product_id` [実際の結果を記入]
- **データ型**: TEXT

### 1.2 IDカラムの関係
```
=== external_products ID構造 ===
id                          | product_id                | ID一致状況 | title              | source_brand
---------------------------|---------------------------|-----------|-------------------|-------------
[例: rakuten_12345]        | [例: rakuten_12345]       | 同じ値     | サンプル商品1      | UNIQLO
[例: uuid-xxx-xxx]         | [例: UNIQLO_商品名_3990]   | 異なる値   | サンプル商品2      | UNIQLO
```

**重要な発見**:
- [ ] `id`と`product_id`は同じ値である
- [ ] `id`と`product_id`は異なる値である（←問題の可能性）

### 1.3 カラム構成（主要部分）
| カラム名 | データ型 | NULL許可 | 備考 |
|---------|---------|----------|------|
| id | text | NO | プライマリキー |
| product_id | text | YES | 商品識別子 |
| title | text | YES | 商品名 |
| price | numeric | YES | 価格 |
| ... | ... | ... | ... |

## 2. swipes テーブル

### 2.1 外部キー制約
```
=== 外部キー制約 ===
参照元              | → | 参照先
-------------------|---|------------------------
swipes.product_id  | → | external_products.id
```

**重要**: swipesテーブルは`external_products.id`を参照している

### 2.2 データ整合性
```
=== データ整合性 ===
整合性チェック結果: 問題なし: すべてのスワイプが有効な商品を参照
```

## 3. ID形式の分析

### 3.1 現在のID形式パターン
```
IDパターン                    | 件数   | 最新追加日
-----------------------------|--------|------------
新形式（ブランド_タイトル_価格）| 15000  | 2024-XX-XX
数値のみ（楽天商品コード）      | 5000   | 2024-XX-XX
UNIQLO形式                   | 3000   | 2024-XX-XX
GU形式                       | 2000   | 2024-XX-XX
```

### 3.2 最新商品のID例
```
id                                    | product_id                          | source_brand | created_at
-------------------------------------|-------------------------------------|--------------|------------
UNIQLO_ウルトラライトダウン_5990      | UNIQLO_ウルトラライトダウン_5990     | UNIQLO       | 2024-XX-XX
GU_スウェットプルパーカー_1990        | GU_スウェットプルパーカー_1990       | GU           | 2024-XX-XX
```

## 4. 発見された問題点

### 🔴 重大な問題
- [ ] なし

### 🟡 要確認事項
- [ ] `id`と`product_id`の役割が不明確
- [ ] 新旧のID形式が混在している
- [ ] 同じ商品が異なるIDで登録されている可能性

### 🟢 問題なし
- [x] 外部キー制約は正しく設定されている
- [x] データ整合性は保たれている

## 5. 推奨アクション

### 即時対応が必要
1. **[必要/不要]** 外部キー制約の修正
   - 現状: swipes.product_id → external_products.id
   - 理想: [変更不要 or 修正内容を記載]

### 中期的対応
1. **ID体系の統一**
   - 新規同期時のID生成ロジックを確認
   - 既存データの移行計画を策定

2. **重複データの確認と対処**
   - 同じ商品が複数のIDで存在していないか確認
   - 必要に応じてマージ処理を実施

### 監視項目
1. 新規商品追加時のID形式
2. スワイプデータの整合性
3. パフォーマンスへの影響

## 6. 結論

**現状評価**: 
- [ ] 本番環境への展開に問題なし
- [ ] 軽微な修正後に展開可能
- [ ] 重大な問題があり、修正が必要

**次のステップ**:
1. [具体的なアクションを記載]
2. [具体的なアクションを記載]

---
記録者: [名前]
レビュー者: [名前]
