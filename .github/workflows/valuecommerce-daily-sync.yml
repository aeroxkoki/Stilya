name: ValueCommerce Daily Sync

on:
  # æ—¥æ¬¡å®Ÿè¡Œï¼ˆæ—¥æœ¬æ™‚é–“ åˆå‰3æ™‚ï¼‰
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 = JST 03:00
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼·åˆ¶çš„ã«åŒæœŸã‚’å®Ÿè¡Œ'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  sync-valuecommerce:
    runs-on: ubuntu-latest
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ30åˆ†ï¼‰
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check ValueCommerce status
        id: check_status
        run: |
          if [ "${{ secrets.VALUECOMMERCE_ENABLED }}" = "true" ] || [ "${{ github.event.inputs.force_sync }}" = "true" ]; then
            echo "sync_enabled=true" >> $GITHUB_OUTPUT
            echo "âœ… ãƒãƒªãƒ¥ãƒ¼ã‚³ãƒžãƒ¼ã‚¹åŒæœŸãŒæœ‰åŠ¹ã§ã™"
          else
            echo "sync_enabled=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ ãƒãƒªãƒ¥ãƒ¼ã‚³ãƒžãƒ¼ã‚¹åŒæœŸã¯ç„¡åŠ¹ã§ã™"
          fi

      - name: Run ValueCommerce sync
        if: steps.check_status.outputs.sync_enabled == 'true'
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          VALUECOMMERCE_TOKEN: ${{ secrets.VALUECOMMERCE_TOKEN }}
          VALUECOMMERCE_ENABLED: ${{ secrets.VALUECOMMERCE_ENABLED }}
        run: |
          echo "ðŸ”„ ãƒãƒªãƒ¥ãƒ¼ã‚³ãƒžãƒ¼ã‚¹å•†å“åŒæœŸã‚’é–‹å§‹..."
          node scripts/sync/sync-valuecommerce-products.js

      - name: Generate summary
        if: always()
        run: |
          echo "## ãƒãƒªãƒ¥ãƒ¼ã‚³ãƒžãƒ¼ã‚¹åŒæœŸçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- å®Ÿè¡Œæ—¥æ™‚: $(TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_status.outputs.sync_enabled }}" = "true" ]; then
            echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… å®Ÿè¡Œæ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç„¡åŠ¹ï¼‰" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### è¨­å®šçŠ¶æ…‹" >> $GITHUB_STEP_SUMMARY
          echo "- VALUECOMMERCE_ENABLED: ${{ secrets.VALUECOMMERCE_ENABLED }}" >> $GITHUB_STEP_SUMMARY
          echo "- å¼·åˆ¶å®Ÿè¡Œ: ${{ github.event.inputs.force_sync || 'false' }}" >> $GITHUB_STEP_SUMMARY

      - name: Error notification
        if: failure()
        run: |
          echo "âŒ ãƒãƒªãƒ¥ãƒ¼ã‚³ãƒžãƒ¼ã‚¹åŒæœŸã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "è©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
