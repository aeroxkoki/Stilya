name: Test Suite

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_ENV: test
  NODE_OPTIONS: "--max-old-space-size=4096 --no-warnings --experimental-vm-modules"
  TZ: "Asia/Tokyo"

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20
        cache: 'npm'
    
    - name: Setup environment
      run: |
        # CIã«é©ã—ãŸnpmrcè¨­å®š
        echo "cache=false" > .npmrc
        echo "prefer-offline=false" >> .npmrc
        echo "fund=false" >> .npmrc
        echo "audit=false" >> .npmrc
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        rm -rf node_modules/.cache
        rm -rf ~/.expo/cache
        rm -rf ~/.metro-cache
    
    - name: Install dependencies
      run: |
        npm ci --no-audit --no-fund
        npm install --no-save jest-junit@16.0.0 patch-package
        
        # Metroé–¢é€£ä¾å­˜é–¢ä¿‚ã‚’æƒãˆã‚‹ï¼ˆãƒ†ã‚¹ãƒˆç’°å¢ƒç”¨ï¼‰
        npm install --no-save \
          metro@0.77.0 \
          metro-core@0.77.0 \
          @babel/runtime@7.27.1
      
    - name: Prepare test environment
      run: |
        # 1. ãƒ‘ãƒƒãƒã®é©ç”¨
        if [ -d "patches" ] && [ "$(ls -A patches)" ]; then
          echo "âœ… Applying patches with patch-package"
          npx patch-package
        else
          # ä»£æ›¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
          echo "âš™ï¸ Running legacy patch script"
          chmod +x ./scripts/patch-jest-expo.sh
          ./scripts/patch-jest-expo.sh
        fi
        
        # 2. TerminalReporterã®è¨­å®š
        echo "ğŸ› ï¸ Setting up test reporters"
        mkdir -p __tests__
        
        # Jestãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ã‚¿ãƒ¼ã¨Metroã®TerminalReporterã‚’å…±é€šã‚¹ã‚¯ãƒªãƒ—ãƒˆã§æº–å‚™
        chmod +x ./scripts/create-terminal-reporter.sh
        ./scripts/create-terminal-reporter.sh
        
        # 3. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã®ãŸã‚ã®ç’°å¢ƒå¤‰æ•°
        echo "âœ“ Test environment ready"
    
    - name: Run tests
      run: |
        # uuidå•é¡Œã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
        npm run test:fix-uuid
        
        # JUnitå½¢å¼ã§ãƒ¬ãƒãƒ¼ãƒˆã‚’å‡ºåŠ› (CIçµ±åˆç”¨)
        JEST_JUNIT_OUTPUT_DIR=./test-results JEST_JUNIT_OUTPUT_NAME=junit.xml \
        npx jest --config jest.config.js --ci --reporters=default --reporters=jest-junit
      
    - name: Generate test summary
      if: always()
      run: |
        if [ -d "test-results" ]; then
          echo "ğŸ“Š Generating test summary"
          npm run test:summary || true
        fi
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: |
          test-results/
          **/junit*.xml
