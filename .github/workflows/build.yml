name: EAS Build for Stilya (MVP)

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      EAS_SKIP_JAVASCRIPT_BUNDLING: 1
      NODE_OPTIONS: "--max-old-space-size=8192"
      NODE_ENV: "production"
      # Android Keystoreé–¢é€£ã®ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ 
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: ğŸ”§ Enable Yarn
        run: corepack enable

      - name: ğŸ“¦ Install dependencies
        run: yarn install

      - name: ğŸ§¹ Clear cache
        run: |
          rm -rf ~/.expo ~/.cache/metro .expo .expo-shared
          yarn cache clean

      - name: ğŸ”§ Install EAS CLI
        run: yarn global add eas-cli@16.6.1

      - name: ğŸ”‘ Setup Android keystore
        run: |
          echo "Setting up Android keystore..."
          # android/app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ã‚’ç¢ºèªã—ã¦ä½œæˆ
          mkdir -p android/app
          
          # credentials.json ã‚’ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä½œæˆ
          echo '{
            "android": {
              "keystore": {
                "keystorePath": "android/app/stilya-keystore.jks",
                "keystorePassword": "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}",
                "keyAlias": "${{ secrets.ANDROID_KEY_ALIAS }}",
                "keyPassword": "${{ secrets.ANDROID_KEY_PASSWORD }}"
              }
            }
          }' > credentials.json
          
          # ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
          echo "Current directory: $(pwd)"
          echo "Credentials file location: $(ls -la credentials.json || echo 'Not found')"
          
          # BASE64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚­ãƒ¼ã‚¹ãƒˆã‚¢ãŒã‚ã‚‹å ´åˆã¯ãƒ‡ã‚³ãƒ¼ãƒ‰
          if [ ! -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/stilya-keystore.jks
            echo "Keystore decoded and saved to android/app/stilya-keystore.jks"
            ls -la android/app/stilya-keystore.jks || echo "Keystore file not found!"
          else
            echo "No ANDROID_KEYSTORE_BASE64 provided, skipping keystore setup"
            # ãƒ€ãƒŸãƒ¼ã®ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
            dd if=/dev/urandom of=android/app/stilya-keystore.jks bs=1k count=2
            echo "Created dummy keystore for testing"
          fi
          
          # credentials.jsonã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
          chmod 644 credentials.json
          echo "Set credentials.json permissions to 644"

      - name: ğŸ” ãƒ“ãƒ«ãƒ‰å‰æº–å‚™ã‚’å®Ÿè¡Œ
        run: ./scripts/pre-eas-build.sh

      - name: ğŸ” CredentialsçŠ¶æ…‹ã‚’ç¢ºèª
        run: ./scripts/debug-credentials.sh

      - name: ğŸ›  Run EAS build
        run: |
          echo "ğŸ“± Running EAS build..."
          eas whoami
          
          # credentials.jsonã®å­˜åœ¨ã‚’ç¢ºèª
          if [ -f "credentials.json" ]; then
            echo "credentials.json found at project root"
            cat credentials.json | sed 's/"keystorePassword": ".*"/"keystorePassword": "****"/g' | sed 's/"keyPassword": ".*"/"keyPassword": "****"/g'
          else
            echo "credentials.json NOT found - creating it now"
            echo '{
              "android": {
                "keystore": {
                  "keystorePath": "android/app/stilya-keystore.jks",
                  "keystorePassword": "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}",
                  "keyAlias": "${{ secrets.ANDROID_KEY_ALIAS }}",
                  "keyPassword": "${{ secrets.ANDROID_KEY_PASSWORD }}"
                }
              }
            }' > credentials.json
            echo "credentials.json created"
          fi
          
          # Keystoreã®å­˜åœ¨ã‚‚ç¢ºèª
          if [ -f "android/app/stilya-keystore.jks" ]; then
            echo "Keystore file exists"
          else
            echo "Keystore file missing - will need to create it"
          fi
          
          # ç’°å¢ƒå¤‰æ•°ã®å‡ºåŠ›ï¼ˆç§˜å¯†ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ã¯å«ã‚ãªã„ï¼‰
          echo "Environment variable checks:"
          echo "EAS_SKIP_JAVASCRIPT_BUNDLING: $EAS_SKIP_JAVASCRIPT_BUNDLING"
          echo "NODE_ENV: $NODE_ENV"
          
          # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ - eas.jsonã®è¨­å®šã§è‡ªå‹•çš„ã«credentials.jsonãŒä½¿ç”¨ã•ã‚Œã‚‹
          eas build --platform android --profile ci --non-interactive --no-wait
          echo "âœ… ãƒ“ãƒ«ãƒ‰ã¯ EAS Build ã‚µãƒ¼ãƒãƒ¼ã§å®Ÿè¡Œã•ã‚Œã¾ã™"
