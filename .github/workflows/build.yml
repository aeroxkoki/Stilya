name: Android Build for Stilya (MVP)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      build_type:
        description: 'ãƒ“ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - eas

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      EAS_SKIP_JAVASCRIPT_BUNDLING: 1
      NODE_OPTIONS: "--max-old-space-size=8192"
      NODE_ENV: "production"
      # Android Keystoreé–¢é€£ã®ç’°å¢ƒå¤‰æ•°
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ”§ Enable Yarn
        run: corepack enable

      - name: ğŸ“¦ Install dependencies
        run: yarn install

      - name: ğŸ§¹ Clear cache
        run: |
          rm -rf ~/.expo ~/.cache/metro .expo .expo-shared
          yarn cache clean

      - name: ğŸ“¦ Fix Metro dependencies
        run: |
          chmod +x ./scripts/fix-metro-incompatibility.sh
          ./scripts/fix-metro-incompatibility.sh

      - name: ğŸ”§ Install EAS CLI
        run: yarn global add eas-cli@16.6.1

      - name: ğŸ”‘ Setup Android keystore
        run: |
          echo "Setting up Android keystore..."
          # android/app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ã‚’ç¢ºèªã—ã¦ä½œæˆ
          mkdir -p android/app
          
          # credentials.json ã‚’ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä½œæˆ
          echo '{
            "android": {
              "keystore": {
                "keystorePath": "android/app/stilya-keystore.jks",
                "keystorePassword": "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}",
                "keyAlias": "${{ secrets.ANDROID_KEY_ALIAS }}",
                "keyPassword": "${{ secrets.ANDROID_KEY_PASSWORD }}"
              }
            }
          }' > credentials.json
          
          # BASE64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚­ãƒ¼ã‚¹ãƒˆã‚¢ãŒã‚ã‚‹å ´åˆã¯ãƒ‡ã‚³ãƒ¼ãƒ‰
          if [ ! -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/stilya-keystore.jks
            echo "Keystore decoded and saved to android/app/stilya-keystore.jks"
            ls -la android/app/stilya-keystore.jks || echo "Keystore file not found!"
          else
            echo "No ANDROID_KEYSTORE_BASE64 provided, running create-dummy-keystore.sh"
            chmod +x ./scripts/create-dummy-keystore.sh
            ./scripts/create-dummy-keystore.sh
          fi
          
          # credentials.jsonã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
          chmod 644 credentials.json
          echo "Set credentials.json permissions to 644"

      - name: ğŸ” ãƒ“ãƒ«ãƒ‰å‰æº–å‚™ã‚’å®Ÿè¡Œ
        run: |
          chmod +x ./scripts/pre-eas-build.sh
          ./scripts/pre-eas-build.sh

      - name: ğŸ” CredentialsçŠ¶æ…‹ã‚’ç¢ºèª
        run: |
          chmod +x ./scripts/debug-credentials.sh
          ./scripts/debug-credentials.sh

      - name: ğŸ“± ãƒ“ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ã®æ±ºå®š
        id: build_type
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "BUILD_TYPE=${{ github.event.inputs.build_type }}" >> $GITHUB_ENV
          else
            echo "BUILD_TYPE=local" >> $GITHUB_ENV
          fi
          echo "é¸æŠã•ã‚ŒãŸãƒ“ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—: ${{ env.BUILD_TYPE }}"

      - name: ğŸ›  Run EAS build
        if: env.BUILD_TYPE == 'eas'
        run: |
          echo "ğŸ“± Running EAS build..."
          eas whoami
          
          # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ - EAS Build
          eas build --platform android --profile ci --non-interactive --no-wait
          echo "âœ… ãƒ“ãƒ«ãƒ‰ã¯ EAS Build ã‚µãƒ¼ãƒãƒ¼ã§å®Ÿè¡Œã•ã‚Œã¾ã™"

      - name: ğŸ›  Run Local build
        if: env.BUILD_TYPE == 'local'
        run: |
          echo "ğŸ“± Running local build..."
          
          # ã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ã‚’æ˜ç¤ºçš„ã«è¨­å®š
          export EXPO_NO_CACHE=true
          export EAS_SKIP_JAVASCRIPT_BUNDLING=1
          export NODE_OPTIONS="--max-old-space-size=8192"
          
          # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œï¼ˆäº’æ›æ€§ä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ï¼‰
          npm run fix-metro-compatibility
          chmod +x ./scripts/local-android-build.sh
          bash ./scripts/local-android-build.sh
          
          # ãƒ“ãƒ«ãƒ‰çµæœã®ç¢ºèª
          if [ -f "stilya-release.apk" ]; then
            echo "âœ… Local build successful"
            ls -la stilya-release.apk
          else
            echo "âŒ Local build failed"
            exit 1
          fi

      - name: ğŸ“¦ Upload APK artifact
        if: env.BUILD_TYPE == 'local' && success()
        uses: actions/upload-artifact@v4
        with:
          name: stilya-apk
          path: stilya-release.apk
          retention-days: 7
