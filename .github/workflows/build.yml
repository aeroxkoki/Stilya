name: Stilya CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: NODE_OPTIONS ã®ç’°å¢ƒå¤‰æ•°è¨­å®š
        run: echo "NODE_OPTIONS=--max-old-space-size=8192" >> $GITHUB_ENV
      
      - name: Expo CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g expo-cli@latest eas-cli@latest
      
      - name: npm ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
      
      - name: Metroä¾å­˜é–¢ä¿‚ã®ä¿®æ­£
        run: |
          chmod +x ./scripts/fix-metro-dependencies.sh
          ./scripts/fix-metro-dependencies.sh
      
      - name: Jest è¨­å®šã®æ‹¡å¼µ
        run: |
          echo "Jestã®è¨­å®šã‚’æ‹¡å¼µã—ã¾ã™..."
          # jest.config.jsã«çµæœãƒ¬ãƒãƒ¼ã‚¿ãƒ¼ã‚’è¿½åŠ 
          grep -q "reporters:" jest.config.js || node -e "
            const fs = require('fs');
            const config = require('./jest.config.js');
            
            config.reporters = [
              'default',
              ['jest-junit', {
                outputDirectory: 'test-results',
                outputName: 'junit.xml',
              }]
            ];
            
            fs.writeFileSync('jest.config.js', 'module.exports = ' + JSON.stringify(config, null, 2));
          "
          # jest-junit ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
          npm list jest-junit || npm install --save-dev jest-junit
      
      - name: åŸºæœ¬ãƒ†ã‚¹ãƒˆï¼ˆå¿…é ˆï¼‰
        id: basic_tests
        run: npm run test src/__tests__/basic.test.js src/__tests__/simple.test.js -- --json --outputFile=basic-test-results.json
        continue-on-error: true
      
      - name: é‡è¦ãªæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆå¿…é ˆï¼‰
        id: auth_tests
        run: npm run test src/__tests__/auth/authStore.test.ts -- --json --outputFile=auth-test-results.json
        continue-on-error: true
        
      - name: ãã®ä»–ã®ãƒ†ã‚¹ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        id: other_tests
        run: |
          echo "ãã®ä»–ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œã—ã¾ã™ï¼‰"
          npm run test -- --testPathIgnorePatterns="basic.test.js|simple.test.js|authStore.test.ts" --json --outputFile=other-test-results.json || echo "ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸãŒã€é–‹ç™ºã‚’ç¶™ç¶šã—ã¾ã™"
        continue-on-error: true
      
      - name: ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ã®ç”Ÿæˆ
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = '## ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ ğŸ“Š\n\n';
            
            // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            const readTestResults = (fileName, testType) => {
              try {
                if (fs.existsSync(fileName)) {
                  const data = JSON.parse(fs.readFileSync(fileName, 'utf8'));
                  const totalTests = data.numTotalTests || 0;
                  const passedTests = data.numPassedTests || 0;
                  const failedTests = data.numFailedTests || 0;
                  const pendingTests = data.numPendingTests || 0;
                  
                  // çµæœè¡¨ç¤ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œ
                  summary += `### ${testType} (${passedTests}/${totalTests})\n\n`;
                  
                  if (failedTests > 0) {
                    summary += `âŒ **å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆ: ${failedTests}ä»¶**\n\n`;
                    summary += '| ãƒ†ã‚¹ãƒˆå | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |\n';
                    summary += '| ------- | --------------- |\n';
                    
                    const failedTestDetails = data.testResults
                      .flatMap(suite => suite.assertionResults)
                      .filter(test => test.status === 'failed')
                      .map(test => {
                        const testName = test.fullName || test.title;
                        const errorMsg = test.failureMessages[0]
                          ?.split('\n')[0]
                          ?.replace(/\|/g, '\\|')
                          ?.substring(0, 100) + (test.failureMessages[0]?.length > 100 ? '...' : '') || 'ã‚¨ãƒ©ãƒ¼è©³ç´°ãªã—';
                        
                        return `| ${testName} | ${errorMsg} |`;
                      });
                    
                    summary += failedTestDetails.join('\n');
                    summary += '\n\n';
                  } else {
                    summary += `âœ… **ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ**\n\n`;
                  }
                  
                  return { totalTests, passedTests, failedTests, pendingTests };
                }
              } catch (error) {
                summary += `### ${testType} - çµæœè§£æã‚¨ãƒ©ãƒ¼\n\n`;
                summary += `âš ï¸ **ãƒ†ã‚¹ãƒˆçµæœã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}**\n\n`;
              }
              
              return { totalTests: 0, passedTests: 0, failedTests: 0, pendingTests: 0 };
            };
            
            // å„ãƒ†ã‚¹ãƒˆçµæœã‚’èª­ã¿å–ã‚Š
            const basicResults = readTestResults('basic-test-results.json', 'Basic Tests');
            const authResults = readTestResults('auth-test-results.json', 'Auth Tests');
            const otherResults = readTestResults('other-test-results.json', 'Other Tests');
            
            // ç·åˆã‚¹ã‚¿ãƒƒãƒ„
            const totalResults = {
              totalTests: basicResults.totalTests + authResults.totalTests + otherResults.totalTests,
              passedTests: basicResults.passedTests + authResults.passedTests + otherResults.passedTests,
              failedTests: basicResults.failedTests + authResults.failedTests + otherResults.failedTests,
              pendingTests: basicResults.pendingTests + authResults.pendingTests + otherResults.pendingTests
            };
            
            // åˆæ ¼ç‡ã®è¨ˆç®—
            const passRate = totalResults.totalTests > 0 
              ? Math.round((totalResults.passedTests / totalResults.totalTests) * 100) 
              : 0;
            
            // ç·åˆã‚µãƒãƒªãƒ¼ã‚’è¿½åŠ 
            summary += `### ç·åˆçµæœ\n\n`;
            summary += `- å…¨ãƒ†ã‚¹ãƒˆ: ${totalResults.totalTests}\n`;
            summary += `- æˆåŠŸ: ${totalResults.passedTests} âœ…\n`;
            summary += `- å¤±æ•—: ${totalResults.failedTests} âŒ\n`;
            summary += `- ä¿ç•™: ${totalResults.pendingTests} â³\n`;
            summary += `- åˆæ ¼ç‡: ${passRate}%\n\n`;
            
            // ãƒ†ã‚¹ãƒˆçµæœã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
            const testStatus = totalResults.failedTests === 0 ? 'âœ… PASS' : 'âŒ FAIL';
            summary += `## æœ€çµ‚åˆ¤å®š: ${testStatus}\n\n`;
            
            if (totalResults.failedTests > 0) {
              summary += `> **æ³¨æ„**: å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆãŒã‚ã‚Šã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚\n`;
            }
            
            // ã‚µãƒãƒªãƒ¼ä½œæˆ
            await core.summary
              .addHeading('Stilya ãƒ†ã‚¹ãƒˆçµæœ')
              .addRaw(summary)
              .write();
            
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
            console.log(summary);
            
            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«æƒ…å ±ã‚’æ¸¡ã™
            core.setOutput('testsPassed', totalResults.failedTests === 0);
            core.setOutput('passRate', passRate);
      
      - name: ãƒ†ã‚¹ãƒˆçµæœã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            basic-test-results.json
            auth-test-results.json
            other-test-results.json
            test-results/*.xml
          if-no-files-found: ignore
      
      - name: ãƒ†ã‚¹ãƒˆçµæœç¢ºèª
        if: always()
        run: |
          echo "ãƒ†ã‚¹ãƒˆçµæœã¯ GitHub Actions ã®ã‚µãƒãƒªãƒ¼ã§ç¢ºèªã§ãã¾ã™ã€‚"
          FAIL_COUNT=$(cat basic-test-results.json auth-test-results.json other-test-results.json 2>/dev/null | grep -o '"numFailedTests":[0-9]*' | awk -F: '{sum+=$2} END {print sum}')
          
          if [ "$FAIL_COUNT" -gt "0" ]; then
            echo "::warning::ãƒ†ã‚¹ãƒˆã«å¤±æ•—ãŒã‚ã‚Šã¾ã™ã€‚ã‚µãƒãƒªãƒ¼ã‚¿ãƒ–ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            echo "ä»¥ä¸‹ã®å¿…é ˆãƒ†ã‚¹ãƒˆã¯ã™ã¹ã¦æˆåŠŸã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š"
            echo "- Basic Tests (basic.test.js, simple.test.js)"
            echo "- Auth Tests (authStore.test.ts)"
            
            # å¿…é ˆãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å¤±æ•—ã•ã›ã‚‹
            BASIC_FAIL=$(cat basic-test-results.json 2>/dev/null | grep -o '"numFailedTests":[0-9]*' | awk -F: '{print $2}')
            AUTH_FAIL=$(cat auth-test-results.json 2>/dev/null | grep -o '"numFailedTests":[0-9]*' | awk -F: '{print $2}')
            
            if [ "$BASIC_FAIL" -gt "0" ] || [ "$AUTH_FAIL" -gt "0" ]; then
              echo "::error::å¿…é ˆãƒ†ã‚¹ãƒˆã«å¤±æ•—ãŒã‚ã‚Šã¾ã™ã€‚"
              exit 1
            else
              echo "::notice::å¿…é ˆãƒ†ã‚¹ãƒˆã¯æˆåŠŸã—ã¦ã„ã¾ã™ã€‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®ã‚¨ãƒ©ãƒ¼ã¯é–‹ç™ºã‚’ç¶šè¡Œã§ãã¾ã™ã€‚"
            fi
          else
            echo "::notice::ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼"
          fi
  
  build:
    name: ã‚¢ãƒ—ãƒªãƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-latest
    needs: test
    # main/developãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã¾ãŸã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿ãƒ“ãƒ«ãƒ‰
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    env:
      EAS_SKIP_JAVASCRIPT_BUNDLING: "1"
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: NODE_OPTIONS ã®ç’°å¢ƒå¤‰æ•°è¨­å®š
        run: echo "NODE_OPTIONS=--max-old-space-size=8192" >> $GITHUB_ENV
      
      - name: Expo CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g expo-cli@latest eas-cli@latest
      
      - name: npm ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
      
      - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
        run: |
          rm -rf node_modules/.cache
          rm -rf ~/.expo/cache
          rm -rf .expo
          rm -rf .expo-shared
      
      - name: Expo ãƒ­ã‚°ã‚¤ãƒ³
        uses: expo/expo-github-action@v8
        with:
          eas-version: '7.8.5'
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: Metroä¾å­˜é–¢ä¿‚ã®ä¿®æ­£
        run: |
          chmod +x ./scripts/fix-metro-dependencies.sh
          ./scripts/fix-metro-dependencies.sh
      
      - name: EASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–
        run: |
          # app.jsonã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’å–å¾—
          PROJECT_ID=$(node -e "console.log(require('./app.json').expo.extra.eas.projectId || '')")
          echo "ğŸ“‹ ProjectID: $PROJECT_ID"
          
          # app.jsonã‹ã‚‰ownerã‚’å–å¾—
          OWNER=$(node -e "console.log(require('./app.json').expo.owner || '')")
          echo "ğŸ‘¤ Owner: $OWNER"
          
          # EASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’æŒ‡å®šï¼‰
          if [ -n "$PROJECT_ID" ]; then
            npx eas-cli project:init --id="$PROJECT_ID" --non-interactive || echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã™ã§ã«å­˜åœ¨ã—ã¾ã™"
          else
            npx eas-cli project:init --non-interactive || echo "æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi
          
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
          npx eas-cli project:info || echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“"
      
      - name: EASãƒ“ãƒ«ãƒ‰ç’°å¢ƒç¢ºèª
        run: |
          chmod +x ./scripts/eas-build-debug.sh
          ./scripts/eas-build-debug.sh
      
      - name: EAS ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’ç¢ºèª
        run: |
          npx eas-cli project:info || echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
          
      - name: app.jsonã®ç¢ºèª
        run: |
          echo "app.json ã®å†…å®¹ç¢ºèªä¸­..."
          cat app.json | grep -A 3 "owner"
          cat app.json | grep -A 3 "projectId"
          
      - name: EAS ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ (è©³ç´°ãƒ¢ãƒ¼ãƒ‰)
        run: |
          echo "ğŸš€ EAS ãƒ“ãƒ«ãƒ‰é–‹å§‹å‰ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢..."
          npm cache clean --force
          rm -rf node_modules/.cache
          rm -rf ~/.expo/cache
          rm -rf .expo
          rm -rf .expo-shared
          rm -rf .metro-cache
          
          echo "ğŸš€ EAS ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œä¸­..."
          npx eas-cli build --platform android --profile ci --non-interactive --verbose
        
      - name: ãƒ“ãƒ«ãƒ‰å®Œäº†é€šçŸ¥
        if: success()
        run: echo "âœ… ãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚"
        
  update:
    name: OTAã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé…ä¿¡
    runs-on: ubuntu-latest
    needs: test
    # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã¾ãŸã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿å®Ÿè¡Œ
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: NODE_OPTIONS ã®ç’°å¢ƒå¤‰æ•°è¨­å®š
        run: echo "NODE_OPTIONS=--max-old-space-size=8192" >> $GITHUB_ENV
      
      - name: Expo CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g expo-cli@latest eas-cli@latest
      
      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
      
      - name: Expo ãƒ­ã‚°ã‚¤ãƒ³
        uses: expo/expo-github-action@v8
        with:
          eas-version: '7.8.5'
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: EAS Update å®Ÿè¡Œ
        run: |
          # Androidå‘ã‘ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
          npx eas-cli update --platform android --message "$(git log -1 --pretty=%B)" --non-interactive
          
          # iOSå‘ã‘ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼ˆå°†æ¥çš„ã«å¿…è¦ãªå ´åˆï¼‰
          # npx eas-cli update --platform ios --message "$(git log -1 --pretty=%B)" --non-interactive
      
      - name: æ›´æ–°å®Œäº†é€šçŸ¥
        if: success()
        run: echo "âœ… OTAã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒæ­£å¸¸ã«é…ä¿¡ã•ã‚Œã¾ã—ãŸã€‚"
