# GitHub Actions Workflow for Expo EAS Build
name: EAS Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: üèó Setup repository
      uses: actions/checkout@v3

    - name: üèó Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20
        cache: 'npm'

    - name: üì¶ Install dependencies
      run: npm ci --legacy-peer-deps

    - name: üöÄ Setup Expo
      uses: expo/expo-github-action@v8
      with:
        eas-version: latest
        token: ${{ secrets.EXPO_TOKEN }}

    - name: üîí Check environment variables
      run: |
        echo "Checking environment variables..."
        [ -n "${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}" ] && echo "‚úÖ SUPABASE_URL is set" || echo "‚ùå SUPABASE_URL is missing"
        [ -n "${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}" ] && echo "‚úÖ SUPABASE_ANON_KEY is set" || echo "‚ùå SUPABASE_ANON_KEY is missing"

    - name: üîç Run TypeScript check
      run: npm run types:check
      continue-on-error: true

    - name: üì± Build preview APK
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: eas build --platform android --profile preview --non-interactive
      env:
        EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
        EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
        EXPO_PUBLIC_RAKUTEN_APP_ID: ${{ secrets.EXPO_PUBLIC_RAKUTEN_APP_ID }}
        EXPO_PUBLIC_RAKUTEN_AFFILIATE_ID: ${{ secrets.EXPO_PUBLIC_RAKUTEN_AFFILIATE_ID }}
