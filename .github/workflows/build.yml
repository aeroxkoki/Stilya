name: Build Stilya App

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # Expo/EASè¨­å®š
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      EAS_SKIP_JAVASCRIPT_BUNDLING: 1
      EAS_NO_VCS: 1
      EAS_LOCAL_BUILD_ARTIFACTS_DIR: ./build-artifacts
      EAS_LOCAL_BUILD_SKIP_CLEANUP: 1
      EXPO_NO_CACHE: 1
      
      # ãƒ“ãƒ«ãƒ‰ç’°å¢ƒè¨­å®š
      NODE_OPTIONS: --max-old-space-size=8192
      NODE_ENV: production
      BUILD_TYPE: local
      
      # ã‚­ãƒ¼ã‚¹ãƒˆã‚¢è¨­å®š
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Clean lock files
        run: |
          rm -f yarn.lock
          echo "âœ… Removed duplicate lock files"

      - name: Install dependencies
        run: |
          npm ci
          npm install -g eas-cli@latest expo-cli@latest
          # metro-configã‚’æ˜ç¤ºçš„ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm install --save-dev @expo/metro-config@0.9.0 --force
          npm dedupe
          echo "âœ… Dependencies installed"

      - name: Create TerminalReporter
        run: |
          mkdir -p node_modules/metro/src/lib
          echo 'class TerminalReporter { constructor(terminal) { this._terminal = terminal; this._errors = []; this._warnings = []; } handleError(error) { this._errors.push(error); } handleWarning(warning) { this._warnings.push(warning); } getErrors() { return this._errors; } getWarnings() { return this._warnings; } update() {} terminal() { return this._terminal; } } module.exports = TerminalReporter;' > node_modules/metro/src/lib/TerminalReporter.js
          chmod 644 node_modules/metro/src/lib/TerminalReporter.js
          echo "âœ… TerminalReporter.js created"

      - name: Verify dependencies
        run: |
          if [ -d "node_modules/@expo/metro-config" ]; then
            echo "âœ… @expo/metro-config is installed"
          else
            echo "âŒ @expo/metro-config is NOT installed"
            # é€šå¸¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è©¦ã¿ã‚‹
            npm install --save-dev @expo/metro-config@0.9.0 --force
            # å†åº¦ç¢ºèª
            if [ -d "node_modules/@expo/metro-config" ]; then
              echo "âœ… @expo/metro-config is now installed"
            else
              echo "âŒ Failed to install @expo/metro-config"
              # å¼·åˆ¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å®Ÿè¡Œï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§å®Ÿè£…ï¼‰
              echo "ğŸš¨ ç·Šæ€¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™..."
              mkdir -p node_modules/@expo/metro-config/build
              echo '{"name":"@expo/metro-config","version":"0.9.0","main":"build/index.js"}' > node_modules/@expo/metro-config/package.json
              echo 'function getDefaultConfig() { return { resolver: { resolverMainFields: ["react-native", "browser", "main"], platforms: ["ios", "android", "web"] }, transformer: { babelTransformerPath: require.resolve("metro-react-native-babel-transformer") } }; }; module.exports = { getDefaultConfig };' > node_modules/@expo/metro-config/build/index.js
              echo "âœ… ç·Šæ€¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
              # å†åº¦ç¢ºèª
              if [ -d "node_modules/@expo/metro-config" ]; then
                echo "âœ… @expo/metro-config ãŒå­˜åœ¨ã—ã¾ã™"
              else
                echo "âŒ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œå…¨ã«å¤±æ•—ã—ã¾ã—ãŸ"
                exit 1
              fi
            fi
          fi

      - name: Clear cache
        run: |
          rm -rf node_modules/.cache
          rm -rf ~/.expo/cache
          rm -rf ~/.metro-cache
          rm -rf .expo
          rm -rf .expo-shared
          echo "âœ… Caches cleared"

      - name: Verify Metro compatibility
        run: |
          if [ -f "node_modules/metro/src/lib/TerminalReporter.js" ]; then
            echo "âœ… TerminalReporter.js exists"
          else
            echo "âŒ TerminalReporter.js not found"
            echo "ğŸ”§ Creating TerminalReporter.js again..."
            mkdir -p node_modules/metro/src/lib
            echo 'class TerminalReporter { constructor(terminal) { this._terminal = terminal; this._errors = []; this._warnings = []; } handleError(error) { this._errors.push(error); } handleWarning(warning) { this._warnings.push(warning); } getErrors() { return this._errors; } getWarnings() { return this._warnings; } update() {} terminal() { return this._terminal; } } module.exports = TerminalReporter;' > node_modules/metro/src/lib/TerminalReporter.js
            
            if [ -f "node_modules/metro/src/lib/TerminalReporter.js" ]; then
              echo "âœ… TerminalReporter.js creation successful"
            else
              echo "âŒ Failed to create TerminalReporter.js - directory issue"
              # æœ€å¾Œã®æ‰‹æ®µ - å¿…è¦ãªã™ã¹ã¦ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å¼·åˆ¶ä½œæˆ
              mkdir -p node_modules/metro
              mkdir -p node_modules/metro/src
              mkdir -p node_modules/metro/src/lib
              echo 'class TerminalReporter { constructor(terminal) { this._terminal = terminal; this._errors = []; this._warnings = []; } handleError(error) { this._errors.push(error); } handleWarning(warning) { this._warnings.push(warning); } getErrors() { return this._errors; } getWarnings() { return this._warnings; } update() {} terminal() { return this._terminal; } } module.exports = TerminalReporter;' > node_modules/metro/src/lib/TerminalReporter.js
              
              if [ -f "node_modules/metro/src/lib/TerminalReporter.js" ]; then
                echo "âœ… Emergency creation successful"
              else
                echo "âŒ Complete failure to create file - will continue anyway"
                # å¤±æ•—ã—ã¦ã‚‚ãƒ“ãƒ«ãƒ‰ã‚’ç¶šè¡Œï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ãŒï¼‰
              fi
            fi
          fi

      - name: Setup Expo
        run: |
          # expo-doctorã‚’å®Ÿè¡Œ
          npx expo-doctor || true # ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã‚‚ç¶šè¡Œ
          
          # expoç’°å¢ƒå¤‰æ•°è¨­å®š
          export EAS_NO_VCS=1
          export EAS_LOCAL_BUILD_ARTIFACTS_DIR=./build-artifacts
          export EAS_LOCAL_BUILD_SKIP_CLEANUP=1
          
          # EASè¨­å®šç¢ºèª
          npx eas-cli --version
          npx expo install --check || true # ä¾å­˜é–¢ä¿‚ã®ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼‰

      - name: Prepare keystore
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        run: |
          mkdir -p android/app
          echo ${{ secrets.ANDROID_KEYSTORE_BASE64 }} | base64 --decode > android/app/stilya-keystore.jks
          echo '{"android":{"keystore":{"keystorePath":"android/app/stilya-keystore.jks","keystorePassword":"${{ secrets.ANDROID_KEYSTORE_PASSWORD }}","keyAlias":"${{ secrets.ANDROID_KEY_ALIAS }}","keyPassword":"${{ secrets.ANDROID_KEY_PASSWORD }}"}}}' > credentials.json
          echo "âœ… Keystore prepared"

      - name: Build Android App
        run: |
          echo "ğŸ—ï¸ local ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™..."
          
          # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ç’°å¢ƒå¤‰æ•°ã‚’æ˜ç¤ºçš„ã«è¨­å®š
          export EAS_NO_VCS=1
          export EAS_LOCAL_BUILD_ARTIFACTS_DIR=./build-artifacts
          export EAS_LOCAL_BUILD_SKIP_CLEANUP=1
          export EXPO_NO_CACHE=1
          export NODE_ENV=production
          
          # ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆã®ãƒ­ã‚°å‡ºåŠ›å¼·åŒ–
          set -o pipefail
          
          # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰
          echo "ğŸ’» ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™..."
          chmod +x ./scripts/local-android-build.sh
          ./scripts/local-android-build.sh
          
          # ãƒ“ãƒ«ãƒ‰çµæœã®ç¢ºèª
          if [ -f "stilya-release.apk" ]; then
            echo "âœ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸ"
            ls -la stilya-release.apk
          else
            echo "âŒ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ"
            # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°åé›†
            mkdir -p build-logs
            find . -name "*.log" -type f -exec cp {} build-logs/ \;
            find android -name "*.log" -type f -exec cp {} build-logs/ \;
            echo "ãƒ­ã‚°ã‚’ build-logs ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
            exit 1
          fi

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: stilya-app
          path: stilya-release.apk
          
      - name: Upload Build Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build-logs/
            **/build/**/*.log
            android/app/build/outputs/logs/
            ~/.npm/_logs/
