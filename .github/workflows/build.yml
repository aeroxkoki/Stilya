name: Android Build for Stilya (MVP)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      build_type:
        description: 'ãƒ“ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - eas

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      EAS_SKIP_JAVASCRIPT_BUNDLING: 1
      NODE_OPTIONS: "--max-old-space-size=8192"
      NODE_ENV: "production"
      BUILD_TYPE: ${{ github.event.inputs.build_type || 'local' }}
      # Android Keystoreé–¢é€£ã®ç’°å¢ƒå¤‰æ•°
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'

      - name: ğŸ”§ Enable Yarn
        run: corepack enable

      - name: ğŸ”„ Update metro.config.js
        run: |
          echo "ğŸ“ metro.config.js ã‚’ç¢ºèªãƒ»æ›´æ–°ã—ã¾ã™"
          # metro.config.js ãŒæ—¢ã«æœ€æ–°ã‹ã‚’ç¢ºèª
          if ! grep -q "metro-stilya-cache" metro.config.js 2>/dev/null; then
            echo "âš ï¸ metro.config.js ã‚’æœ€æ–°ç‰ˆã«æ›´æ–°ã—ã¾ã™"
            cp .github/workflows/templates/metro.config.js metro.config.js || echo "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™"
          else
            echo "âœ… metro.config.js ã¯æœ€æ–°ã§ã™"
          fi

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™..."
          yarn install --frozen-lockfile
          
          # ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ˜ç¤ºçš„ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          yarn add --dev metro@0.77.0 metro-config@0.77.0 @expo/metro-config@0.9.0 metro-minify-terser@0.77.0 --exact

      - name: ğŸ§¹ Clear cache
        run: |
          echo "ğŸ§¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™..."
          rm -rf node_modules/.cache
          rm -rf ~/.expo ~/.cache/metro .expo .expo-shared
          rm -rf $TMPDIR/metro-* 2>/dev/null || true

      - name: ğŸ“ Setup TerminalReporter
        run: |
          echo "ğŸ“ TerminalReporter.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™..."
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p node_modules/metro/src/lib
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          cat > node_modules/metro/src/lib/TerminalReporter.js << 'EOL'
          /**
           * Copyright (c) Meta Platforms, Inc. and affiliates.
           *
           * This source code is licensed under the MIT license found in the
           * LICENSE file in the root directory of this source tree.
           *
           * @flow strict-local
           * @format
           */
          
          'use strict';
          
          /**
           * Metro Reporter for compatibility with Expo SDK 53.
           * This is a simplified implementation that provides required functionality.
           */
          class TerminalReporter {
            constructor(terminal) {
              this._terminal = terminal;
              this._errors = [];
              this._warnings = [];
            }
          
            handleError(error) {
              this._errors.push(error);
            }
          
            handleWarning(warning) {
              this._warnings.push(warning);
            }
          
            getErrors() {
              return this._errors;
            }
          
            getWarnings() {
              return this._warnings;
            }
          
            update() {}
            
            terminal() { 
              return this._terminal; 
            }
          }
          
          module.exports = TerminalReporter;
          EOL
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ -f "node_modules/metro/src/lib/TerminalReporter.js" ]; then
            ls -la node_modules/metro/src/lib/TerminalReporter.js
            echo "âœ… TerminalReporter.js ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ"
          else
            echo "âŒ TerminalReporter.js ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

      - name: ğŸ”§ Install EAS CLI
        run: yarn global add eas-cli@16.6.1

      - name: ğŸ”‘ Setup Android keystore
        run: |
          echo "ğŸ”‘ Android keystore ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™..."
          mkdir -p android/app
          
          # credentials.json ã‚’ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä½œæˆ
          echo '{
            "android": {
              "keystore": {
                "keystorePath": "android/app/stilya-keystore.jks",
                "keystorePassword": "${{ secrets.ANDROID_KEYSTORE_PASSWORD || 'android' }}",
                "keyAlias": "${{ secrets.ANDROID_KEY_ALIAS || 'androiddebugkey' }}",
                "keyPassword": "${{ secrets.ANDROID_KEY_PASSWORD || 'android' }}"
              }
            }
          }' > credentials.json
          
          # BASE64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚­ãƒ¼ã‚¹ãƒˆã‚¢ãŒã‚ã‚‹å ´åˆã¯ãƒ‡ã‚³ãƒ¼ãƒ‰
          if [ ! -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/stilya-keystore.jks
            echo "âœ… ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ã‚’å¾©å·åŒ–ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ãŒæä¾›ã•ã‚Œã¦ã„ãªã„ãŸã‚ãƒ€ãƒŸãƒ¼ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ã‚’ä½œæˆã—ã¾ã™"
            chmod +x ./scripts/create-dummy-keystore.sh
            ./scripts/create-dummy-keystore.sh
          fi
          
          chmod 644 credentials.json

      - name: ğŸ›  Run build
        run: |
          echo "ğŸ—ï¸ ${{ env.BUILD_TYPE }} ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™..."
          
          if [ "${{ env.BUILD_TYPE }}" == "eas" ]; then
            # EAS ãƒ“ãƒ«ãƒ‰
            echo "ğŸŒ EAS ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™..."
            eas build --platform android --profile ci --non-interactive --no-wait
            echo "âœ… ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–ãŒ EAS ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸ"
          else
            # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰
            echo "ğŸ’» ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™..."
            chmod +x ./scripts/local-android-build.sh
            ./scripts/local-android-build.sh
            
            # ãƒ“ãƒ«ãƒ‰çµæœã®ç¢ºèª
            if [ -f "stilya-release.apk" ]; then
              echo "âœ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸ"
              ls -la stilya-release.apk
            else
              echo "âŒ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ"
              exit 1
            fi
          fi

      - name: ğŸ“¦ Upload APK artifact
        if: env.BUILD_TYPE == 'local' && success()
        uses: actions/upload-artifact@v4
        with:
          name: stilya-apk
          path: stilya-release.apk
          retention-days: 7
