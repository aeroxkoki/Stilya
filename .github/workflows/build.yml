name: Stilya CI/CD

# å…¨ä½“ã®ç’°å¢ƒå¤‰æ•°ã‚’ä¸€å…ƒç®¡ç†
env:
  NODE_OPTIONS: "--max-old-space-size=8192"
  EAS_SKIP_JAVASCRIPT_BUNDLING: "1"
  METRO_CONFIG_FIX: "true"
  EXPO_USE_NATIVE_MODULES: "false"
  RCT_NEW_ARCH_ENABLED: "false"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Expo CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g expo-cli@latest eas-cli@latest
      
      - name: npm ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          # package-lock.jsonã¨package.jsonã®åŒæœŸã‚’ç¢ºä¿
          npm install
          # åŒæœŸå¾Œã«clean-installã‚’å®Ÿè¡Œ
          npm ci
      
      - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
        run: |
          set -e
          echo "ğŸ§¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™..."
          rm -rf node_modules/.cache
          rm -rf ~/.expo/cache || true
          rm -rf .expo || true
          rm -rf .expo-shared || true
          rm -rf .metro-cache || true
      
      - name: ä¾å­˜é–¢ä¿‚ã®ä¿®æ­£
        run: |
          # Metroã®ä¾å­˜é–¢ä¿‚ä¿®æ­£
          chmod +x ./scripts/fix-metro-dependencies.sh
          ./scripts/fix-metro-dependencies.sh
          
          # ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ä¾å­˜é–¢ä¿‚ä¿®æ­£
          chmod +x ./scripts/fix-test-dependencies.sh
          ./scripts/fix-test-dependencies.sh
          
      - name: ãƒ†ã‚¹ãƒˆç’°å¢ƒä¿®æ­£
        run: |
          # ãƒ†ã‚¹ãƒˆç’°å¢ƒä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
          chmod +x ./scripts/fix-jest-for-github.sh
          ./scripts/fix-jest-for-github.sh
      
      - name: åŸºæœ¬ãƒ†ã‚¹ãƒˆï¼ˆå¿…é ˆï¼‰
        id: basic_tests
        run: npm run test src/__tests__/basic.test.js src/__tests__/simple.test.js -- --json --outputFile=basic-test-results.json
        continue-on-error: true
      
      - name: é‡è¦ãªæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆå¿…é ˆï¼‰
        id: auth_tests
        run: npm run test src/__tests__/auth/authStore.test.ts -- --json --outputFile=auth-test-results.json
        continue-on-error: true
        
      - name: ãã®ä»–ã®ãƒ†ã‚¹ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        id: other_tests
        run: |
          echo "ãã®ä»–ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œã—ã¾ã™ï¼‰"
          # é€šå¸¸ã®ãã®ä»–ãƒ†ã‚¹ãƒˆ
          npm run test -- --testPathIgnorePatterns="basic.test.js|simple.test.js|authStore.test.ts|optional" --json --outputFile=other-test-results.json || echo "ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸãŒã€é–‹ç™ºã‚’ç¶™ç¶šã—ã¾ã™"
          
          # ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ†ã‚¹ãƒˆ
          mkdir -p test-results
          npm run test:optional -- --json --outputFile=optional-test-results.json || echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®ä¸€éƒ¨ãŒå¤±æ•—ã—ã¾ã—ãŸãŒã€é–‹ç™ºã‚’ç¶™ç¶šã—ã¾ã™"
        continue-on-error: true
      
      - name: ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ã®ç”Ÿæˆ
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = '## ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ ğŸ“Š\n\n';
            
            // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            const readTestResults = (fileName, testType) => {
              try {
                if (fs.existsSync(fileName)) {
                  const data = JSON.parse(fs.readFileSync(fileName, 'utf8'));
                  const totalTests = data.numTotalTests || 0;
                  const passedTests = data.numPassedTests || 0;
                  const failedTests = data.numFailedTests || 0;
                  const pendingTests = data.numPendingTests || 0;
                  
                  // çµæœè¡¨ç¤ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œ
                  summary += `### ${testType} (${passedTests}/${totalTests})\n\n`;
                  
                  if (failedTests > 0) {
                    summary += `âŒ **å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆ: ${failedTests}ä»¶**\n\n`;
                    summary += '| ãƒ†ã‚¹ãƒˆå | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |\n';
                    summary += '| ------- | --------------- |\n';
                    
                    const failedTestDetails = data.testResults
                      .flatMap(suite => suite.assertionResults)
                      .filter(test => test.status === 'failed')
                      .map(test => {
                        const testName = test.fullName || test.title;
                        const errorMsg = test.failureMessages[0]
                          ?.split('\n')[0]
                          ?.replace(/\|/g, '\\|')
                          ?.substring(0, 100) + (test.failureMessages[0]?.length > 100 ? '...' : '') || 'ã‚¨ãƒ©ãƒ¼è©³ç´°ãªã—';
                        
                        return `| ${testName} | ${errorMsg} |`;
                      });
                    
                    summary += failedTestDetails.join('\n');
                    summary += '\n\n';
                  } else {
                    summary += `âœ… **ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ**\n\n`;
                  }
                  
                  return { totalTests, passedTests, failedTests, pendingTests };
                }
              } catch (error) {
                summary += `### ${testType} - çµæœè§£æã‚¨ãƒ©ãƒ¼\n\n`;
                summary += `âš ï¸ **ãƒ†ã‚¹ãƒˆçµæœã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}**\n\n`;
              }
              
              return { totalTests: 0, passedTests: 0, failedTests: 0, pendingTests: 0 };
            };
            
            // å„ãƒ†ã‚¹ãƒˆçµæœã‚’èª­ã¿å–ã‚Š
            const basicResults = readTestResults('basic-test-results.json', 'Basic Tests');
            const authResults = readTestResults('auth-test-results.json', 'Auth Tests');
            const otherResults = readTestResults('other-test-results.json', 'Other Tests');
            const optionalResults = readTestResults('optional-test-results.json', 'Optional Tests');
            
            // ç·åˆã‚¹ã‚¿ãƒƒãƒ„
            const totalResults = {
              totalTests: basicResults.totalTests + authResults.totalTests + otherResults.totalTests + optionalResults.totalTests,
              passedTests: basicResults.passedTests + authResults.passedTests + otherResults.passedTests + optionalResults.passedTests,
              failedTests: basicResults.failedTests + authResults.failedTests + otherResults.failedTests + optionalResults.failedTests,
              pendingTests: basicResults.pendingTests + authResults.pendingTests + otherResults.pendingTests + optionalResults.pendingTests
            };
            
            // åˆæ ¼ç‡ã®è¨ˆç®—
            const passRate = totalResults.totalTests > 0 
              ? Math.round((totalResults.passedTests / totalResults.totalTests) * 100) 
              : 0;
            
            // ç·åˆã‚µãƒãƒªãƒ¼ã‚’è¿½åŠ 
            summary += `### ç·åˆçµæœ\n\n`;
            summary += `- å…¨ãƒ†ã‚¹ãƒˆ: ${totalResults.totalTests}\n`;
            summary += `- æˆåŠŸ: ${totalResults.passedTests} âœ…\n`;
            summary += `- å¤±æ•—: ${totalResults.failedTests} âŒ\n`;
            summary += `- ä¿ç•™: ${totalResults.pendingTests} â³\n`;
            summary += `- åˆæ ¼ç‡: ${passRate}%\n\n`;
            
            // ãƒ†ã‚¹ãƒˆçµæœã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
            const testStatus = totalResults.failedTests === 0 ? 'âœ… PASS' : 'âŒ FAIL';
            summary += `## æœ€çµ‚åˆ¤å®š: ${testStatus}\n\n`;
            
            if (totalResults.failedTests > 0) {
              summary += `> **æ³¨æ„**: å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆãŒã‚ã‚Šã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚\n`;
            }
            
            // ã‚µãƒãƒªãƒ¼ä½œæˆ
            await core.summary
              .addHeading('Stilya ãƒ†ã‚¹ãƒˆçµæœ')
              .addRaw(summary)
              .write();
            
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
            console.log(summary);
            
            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«æƒ…å ±ã‚’æ¸¡ã™
            core.setOutput('testsPassed', totalResults.failedTests === 0);
            core.setOutput('passRate', passRate);
      
      - name: ãƒ†ã‚¹ãƒˆçµæœã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            basic-test-results.json
            auth-test-results.json
            other-test-results.json
            optional-test-results.json
            test-results/*.xml
          if-no-files-found: ignore
      
      - name: ãƒ†ã‚¹ãƒˆçµæœç¢ºèª
        if: always()
        run: |
          echo "ãƒ†ã‚¹ãƒˆçµæœã¯ GitHub Actions ã®ã‚µãƒãƒªãƒ¼ã§ç¢ºèªã§ãã¾ã™ã€‚"
          FAIL_COUNT=$(cat basic-test-results.json auth-test-results.json other-test-results.json optional-test-results.json 2>/dev/null | grep -o '"numFailedTests":[0-9]*' | awk -F: '{sum+=$2} END {print sum}')
          
          if [ "$FAIL_COUNT" -gt "0" ]; then
            echo "::warning::ãƒ†ã‚¹ãƒˆã«å¤±æ•—ãŒã‚ã‚Šã¾ã™ã€‚ã‚µãƒãƒªãƒ¼ã‚¿ãƒ–ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            echo "ä»¥ä¸‹ã®å¿…é ˆãƒ†ã‚¹ãƒˆã¯ã™ã¹ã¦æˆåŠŸã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š"
            echo "- Basic Tests (basic.test.js, simple.test.js)"
            echo "- Auth Tests (authStore.test.ts)"
            
            # å¿…é ˆãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å¤±æ•—ã•ã›ã‚‹
            BASIC_FAIL=$(cat basic-test-results.json 2>/dev/null | grep -o '"numFailedTests":[0-9]*' | awk -F: '{print $2}')
            AUTH_FAIL=$(cat auth-test-results.json 2>/dev/null | grep -o '"numFailedTests":[0-9]*' | awk -F: '{print $2}')
            
            if [ "$BASIC_FAIL" -gt "0" ] || [ "$AUTH_FAIL" -gt "0" ]; then
              echo "::error::å¿…é ˆãƒ†ã‚¹ãƒˆã«å¤±æ•—ãŒã‚ã‚Šã¾ã™ã€‚"
              exit 1
            else
              echo "::notice::å¿…é ˆãƒ†ã‚¹ãƒˆã¯æˆåŠŸã—ã¦ã„ã¾ã™ã€‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®ã‚¨ãƒ©ãƒ¼ã¯é–‹ç™ºã‚’ç¶šè¡Œã§ãã¾ã™ã€‚"
            fi
          else
            echo "::notice::ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼"
          fi

      - name: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°åé›†
        if: failure()
        run: |
          echo "ğŸ“¦ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’åé›†ã—ã¦ã„ã¾ã™..."
          mkdir -p error-logs
          
          # ãƒ†ã‚¹ãƒˆå¤±æ•—æƒ…å ±
          cp *.json error-logs/ 2>/dev/null || echo "JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
          cp -r test-results error-logs/ 2>/dev/null || echo "ãƒ†ã‚¹ãƒˆçµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚Šã¾ã›ã‚“"
          
          # ä¾å­˜é–¢ä¿‚æƒ…å ±
          npm list > error-logs/dependencies.txt 2>&1 || echo "ä¾å­˜é–¢ä¿‚ã®å–å¾—ã«å¤±æ•—"
          npm list expo react react-native metro > error-logs/core-deps.txt 2>&1 || echo "ä¸»è¦ä¾å­˜é–¢ä¿‚ã®å–å¾—ã«å¤±æ•—"
          
          # ç’°å¢ƒæƒ…å ±
          echo "NODE_VERSION=$(node -v)" > error-logs/environment.txt
          echo "NPM_VERSION=$(npm -v)" >> error-logs/environment.txt
          echo "EXPO_CLI=$(expo --version 2>&1)" >> error-logs/environment.txt
          echo "EAS_CLI=$(npx eas-cli --version 2>&1)" >> error-logs/environment.txt
          
          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
          cp *.config.js error-logs/ 2>/dev/null || echo "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
          cp app.json error-logs/ 2>/dev/null || echo "app.jsonãŒã‚ã‚Šã¾ã›ã‚“"
          cp eas.json error-logs/ 2>/dev/null || echo "eas.jsonãŒã‚ã‚Šã¾ã›ã‚“"
          
          # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«
          cp *.log error-logs/ 2>/dev/null || echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“" 
          cp -r ~/.expo/logs/* error-logs/ 2>/dev/null || echo "Expoãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“"
          
          echo "âœ… ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®åé›†ãŒå®Œäº†ã—ã¾ã—ãŸ"
      
      - name: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: error-logs/
          if-no-files-found: ignore
  
  build:
    name: ã‚¢ãƒ—ãƒªãƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-latest
    needs: test
    # main/developãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã¾ãŸã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿ãƒ“ãƒ«ãƒ‰
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Expo CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g expo-cli@latest eas-cli@latest
      
      - name: npm ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          # package-lock.jsonã¨package.jsonã®åŒæœŸã‚’ç¢ºä¿
          npm install
          # åŒæœŸå¾Œã«clean-installã‚’å®Ÿè¡Œ
          npm ci
      
      - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
        run: |
          set -e
          echo "ğŸ§¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™..."
          rm -rf node_modules/.cache
          rm -rf ~/.expo/cache || true
          rm -rf .expo || true
          rm -rf .expo-shared || true
          rm -rf .metro-cache || true
      
      - name: Expo ãƒ­ã‚°ã‚¤ãƒ³
        uses: expo/expo-github-action@v8
        with:
          eas-version: '7.8.5'
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: Metroä¾å­˜é–¢ä¿‚ã®ä¿®æ­£
        run: |
          chmod +x ./scripts/fix-metro-dependencies.sh
          ./scripts/fix-metro-dependencies.sh
      
      - name: EASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–
        run: |
          # æ˜ç¤ºçš„ã«EXPO_TOKENã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³ (æ–°ã—ã„æ§‹æ–‡)
          npx eas-cli login --token "${{ secrets.EXPO_TOKEN }}"
          
          # app.jsonã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’å–å¾—
          PROJECT_ID=$(node -e "console.log(require('./app.json').expo.extra.eas.projectId || '')")
          echo "ğŸ“‹ ProjectID: $PROJECT_ID"
          
          # app.jsonã‹ã‚‰ownerã‚’å–å¾—
          OWNER=$(node -e "console.log(require('./app.json').expo.owner || '')")
          echo "ğŸ‘¤ Owner: $OWNER"
          
          # EASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’æŒ‡å®šï¼‰
          if [ -n "$PROJECT_ID" ]; then
            npx eas-cli project:init --id="$PROJECT_ID" || echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã™ã§ã«å­˜åœ¨ã—ã¾ã™"
          else
            npx eas-cli project:init || echo "æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi
          
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
          npx eas-cli project:info || echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“"
      
      - name: EASãƒ“ãƒ«ãƒ‰ç’°å¢ƒç¢ºèª
        run: |
          chmod +x ./scripts/eas-build-debug.sh
          ./scripts/eas-build-debug.sh
      
      - name: EAS ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’ç¢ºèª
        run: |
          npx eas-cli project:info || echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
          
      - name: app.jsonã®ç¢ºèª
        run: |
          echo "app.json ã®å†…å®¹ç¢ºèªä¸­..."
          cat app.json | grep -A 3 "owner"
          cat app.json | grep -A 3 "projectId"
          
      - name: EAS ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ (è©³ç´°ãƒ¢ãƒ¼ãƒ‰)
        run: |
          echo "ğŸš€ EAS ãƒ“ãƒ«ãƒ‰é–‹å§‹å‰ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢..."
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
          set -e
          npm cache clean --force
          rm -rf node_modules/.cache
          rm -rf ~/.expo/cache || true
          rm -rf .expo || true
          rm -rf .expo-shared || true
          rm -rf .metro-cache || true
          
          # æ˜ç¤ºçš„ã«å†ãƒ­ã‚°ã‚¤ãƒ³ (æ–°ã—ã„æ§‹æ–‡)
          npx eas-cli login --token "${{ secrets.EXPO_TOKEN }}"
          
          # ãƒ–ãƒ©ãƒ³ãƒã«å¿œã˜ã¦ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
          if [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "ğŸš€ develop ãƒ–ãƒ©ãƒ³ãƒå‘ã‘ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œä¸­..."
            npx eas-cli build --platform android --profile preview --verbose
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ğŸš€ main ãƒ–ãƒ©ãƒ³ãƒå‘ã‘æœ¬ç•ªãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œä¸­..."
            npx eas-cli build --platform android --profile production --verbose
          else
            echo "ğŸš€ ãã®ä»–ã®ãƒ–ãƒ©ãƒ³ãƒå‘ã‘CIãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œä¸­..."
            npx eas-cli build --platform android --profile ci --verbose
          fi
        
      - name: ãƒ“ãƒ«ãƒ‰å®Œäº†é€šçŸ¥
        if: success()
        run: echo "âœ… ãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚"
      
      - name: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°åé›†
        if: failure()
        run: |
          echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’åé›†ã—ã¦ã„ã¾ã™..."
          mkdir -p build-error-logs
          
          # ãƒ¡ãƒˆãƒ­ãƒ»EASé–¢é€£ã®ãƒ­ã‚°
          cp -r ~/.expo/logs/* build-error-logs/ 2>/dev/null || echo "Expoãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“"
          cp -r ~/.eas build-error-logs/ 2>/dev/null || echo "EASè¨­å®šãŒã‚ã‚Šã¾ã›ã‚“"
          
          # ä¾å­˜é–¢ä¿‚æƒ…å ±
          npm list > build-error-logs/dependencies.txt 2>&1 || echo "ä¾å­˜é–¢ä¿‚ã®å–å¾—ã«å¤±æ•—"
          npm list expo react react-native metro > build-error-logs/core-deps.txt 2>&1 || echo "ä¸»è¦ä¾å­˜é–¢ä¿‚ã®å–å¾—ã«å¤±æ•—"
          
          # ç’°å¢ƒæƒ…å ±
          echo "NODE_VERSION=$(node -v)" > build-error-logs/environment.txt
          echo "NPM_VERSION=$(npm -v)" >> build-error-logs/environment.txt
          echo "EXPO_CLI=$(expo --version 2>&1)" >> build-error-logs/environment.txt
          echo "EAS_CLI=$(npx eas-cli --version 2>&1)" >> build-error-logs/environment.txt
          echo "METRO_VERSION=$(npm list metro | grep metro)" >> build-error-logs/environment.txt
          
          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
          cp *.config.js build-error-logs/ 2>/dev/null || echo "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
          cp app.json build-error-logs/ 2>/dev/null || echo "app.jsonãŒã‚ã‚Šã¾ã›ã‚“"
          cp eas.json build-error-logs/ 2>/dev/null || echo "eas.jsonãŒã‚ã‚Šã¾ã›ã‚“"
          
          # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«
          cp *.log build-error-logs/ 2>/dev/null || echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
          
          echo "âœ… ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®åé›†ãŒå®Œäº†ã—ã¾ã—ãŸ"
      
      - name: ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-error-logs
          path: build-error-logs/
          if-no-files-found: ignore
        
  update:
    name: OTAã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé…ä¿¡
    runs-on: ubuntu-latest
    needs: test
    # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã¾ãŸã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿å®Ÿè¡Œ
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Expo CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g expo-cli@latest eas-cli@latest
      
      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          # package-lock.jsonã¨package.jsonã®åŒæœŸã‚’ç¢ºä¿
          npm install
          # åŒæœŸå¾Œã«clean-installã‚’å®Ÿè¡Œ
          npm ci
      
      - name: Expo ãƒ­ã‚°ã‚¤ãƒ³
        uses: expo/expo-github-action@v8
        with:
          eas-version: '7.8.5'
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: EAS Update å®Ÿè¡Œ
        run: |
          # æ˜ç¤ºçš„ã«EXPO_TOKENã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆå¿µã®ãŸã‚ï¼‰(æ–°ã—ã„æ§‹æ–‡)
          npx eas-cli login --token "${{ secrets.EXPO_TOKEN }}"
          
          # Androidå‘ã‘ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
          npx eas-cli update --platform android --message "$(git log -1 --pretty=%B)"
          
          # iOSå‘ã‘ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼ˆå°†æ¥çš„ã«å¿…è¦ãªå ´åˆï¼‰
          # npx eas-cli update --platform ios --message "$(git log -1 --pretty=%B)"
      
      - name: æ›´æ–°å®Œäº†é€šçŸ¥
        if: success()
        run: echo "âœ… OTAã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒæ­£å¸¸ã«é…ä¿¡ã•ã‚Œã¾ã—ãŸã€‚"
      
      - name: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°åé›†
        if: failure()
        run: |
          echo "ğŸ“¦ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’åé›†ã—ã¦ã„ã¾ã™..."
          mkdir -p update-error-logs
          
          # Expoãƒ»EASé–¢é€£ã®ãƒ­ã‚°
          cp -r ~/.expo/logs/* update-error-logs/ 2>/dev/null || echo "Expoãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“"
          
          # EAIæƒ…å ±åé›†
          npx eas-cli update:list --limit 5 --json > update-error-logs/update-history.json 2>/dev/null || echo "ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå±¥æ­´ã®å–å¾—ã«å¤±æ•—"
          npx eas-cli project:info --json > update-error-logs/project-info.json 2>/dev/null || echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—"
          
          # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›
          echo "æœ€å¾Œã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œçµæœ: $?" > update-error-logs/exit-status.txt
          
          echo "âœ… ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®åé›†ãŒå®Œäº†ã—ã¾ã—ãŸ"
      
      - name: ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: update-error-logs
          path: update-error-logs/
          if-no-files-found: ignore
