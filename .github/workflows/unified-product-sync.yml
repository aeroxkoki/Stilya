name: Unified Product Sync (ValueCommerce Integration)

# Note: æ—¢å­˜ã®product-sync.ymlï¼ˆJST 2:00å®Ÿè¡Œï¼‰ã¨ã¯åˆ¥ã«ã€
# ãƒãƒªãƒ¥ãƒ¼ã‚³ãƒžãƒ¼ã‚¹çµ±åˆç‰ˆã¨ã—ã¦å‹•ä½œã—ã¾ã™ã€‚
# å°†æ¥çš„ã«ã¯ã“ã¡ã‚‰ã«çµ±ä¸€äºˆå®šã§ã™ãŒã€ç¾åœ¨ã¯ä¸¦è¡Œç¨¼åƒã—ã¦ã„ã¾ã™ã€‚

on:
  # æ—¥æ¬¡å®Ÿè¡Œï¼ˆæ—¥æœ¬æ™‚é–“ åˆå‰4æ™‚ï¼‰- product-sync.ymlã¨ã®ç«¶åˆã‚’é¿ã‘ã‚‹
  schedule:
    - cron: '0 19 * * *'  # UTC 19:00 = JST 04:00
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      sync_rakuten:
        description: 'æ¥½å¤©APIã‚’åŒæœŸ'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      sync_valuecommerce:
        description: 'ãƒãƒªãƒ¥ãƒ¼ã‚³ãƒžãƒ¼ã‚¹APIã‚’åŒæœŸ'
        required: false
        default: 'auto'
        type: choice
        options:
          - 'auto'  # ç’°å¢ƒå¤‰æ•°ã«å¾“ã†
          - 'true'  # å¼·åˆ¶å®Ÿè¡Œ
          - 'false' # ã‚¹ã‚­ãƒƒãƒ—

jobs:
  sync-all-products:
    runs-on: ubuntu-latest
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ60åˆ†ï¼‰
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Set environment
        run: |
          echo "ðŸ” å®Ÿè¡Œç’°å¢ƒã®ç¢ºèª"
          echo "- Node.js: $(node -v)"
          echo "- npm: $(npm -v)"
          echo "- å®Ÿè¡Œæ™‚åˆ»: $(TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M:%S JST')"

      - name: Sync Rakuten products
        if: github.event.inputs.sync_rakuten != 'false'
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          RAKUTEN_APP_ID: ${{ secrets.RAKUTEN_APP_ID }}
        run: |
          echo "ðŸ“¦ æ¥½å¤©å•†å“åŒæœŸã‚’é–‹å§‹..."
          node scripts/sync/sync-rakuten-products.js || {
            echo "âš ï¸ æ¥½å¤©åŒæœŸã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™"
            echo "RAKUTEN_SYNC_STATUS=failed" >> $GITHUB_ENV
          }
          echo "RAKUTEN_SYNC_STATUS=${RAKUTEN_SYNC_STATUS:-success}" >> $GITHUB_ENV

      - name: Check ValueCommerce settings
        id: check_vc
        run: |
          if [ "${{ github.event.inputs.sync_valuecommerce }}" = "true" ]; then
            echo "vc_enabled=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.sync_valuecommerce }}" = "false" ]; then
            echo "vc_enabled=false" >> $GITHUB_OUTPUT
          else
            # auto: ç’°å¢ƒå¤‰æ•°ã«å¾“ã†
            if [ "${{ secrets.VALUECOMMERCE_ENABLED }}" = "true" ]; then
              echo "vc_enabled=true" >> $GITHUB_OUTPUT
            else
              echo "vc_enabled=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Sync ValueCommerce products
        if: steps.check_vc.outputs.vc_enabled == 'true'
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          VALUECOMMERCE_TOKEN: ${{ secrets.VALUECOMMERCE_TOKEN }}
          VALUECOMMERCE_ENABLED: 'true'
        run: |
          echo "ðŸ“¦ ãƒãƒªãƒ¥ãƒ¼ã‚³ãƒžãƒ¼ã‚¹å•†å“åŒæœŸã‚’é–‹å§‹..."
          node scripts/sync/sync-valuecommerce-products.js || {
            echo "âš ï¸ ãƒãƒªãƒ¥ãƒ¼ã‚³ãƒžãƒ¼ã‚¹åŒæœŸã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
            echo "VC_SYNC_STATUS=failed" >> $GITHUB_ENV
          }
          echo "VC_SYNC_STATUS=${VC_SYNC_STATUS:-success}" >> $GITHUB_ENV

      - name: Generate summary report
        if: always()
        run: |
          echo "# ðŸ“Š å•†å“ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## å®Ÿè¡Œæƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- å®Ÿè¡Œæ—¥æ™‚: $(TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒˆãƒªã‚¬ãƒ¼: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## åŒæœŸçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ¥½å¤©çµæžœ
          echo "### ðŸ›ï¸ æ¥½å¤©API" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.sync_rakuten }}" = "false" ]; then
            echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ‰‹å‹•è¨­å®šï¼‰" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ env.RAKUTEN_SYNC_STATUS }}" = "failed" ]; then
            echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âŒ ã‚¨ãƒ©ãƒ¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ãƒãƒªãƒ¥ãƒ¼ã‚³ãƒžãƒ¼ã‚¹çµæžœ
          echo "### ðŸ’¼ ãƒãƒªãƒ¥ãƒ¼ã‚³ãƒžãƒ¼ã‚¹API" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_vc.outputs.vc_enabled }}" != "true" ]; then
            echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç„¡åŠ¹ï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "- ç†ç”±: VALUECOMMERCE_ENABLED=${{ secrets.VALUECOMMERCE_ENABLED }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ env.VC_SYNC_STATUS }}" = "failed" ]; then
            echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âŒ ã‚¨ãƒ©ãƒ¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## è¨­å®šæƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- æ¥½å¤©åŒæœŸ: ${{ github.event.inputs.sync_rakuten || 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒãƒªãƒ¥ãƒ¼ã‚³ãƒžãƒ¼ã‚¹åŒæœŸ: ${{ github.event.inputs.sync_valuecommerce || 'auto' }}" >> $GITHUB_STEP_SUMMARY

      - name: Error notification
        if: failure()
        run: |
          echo "âŒ å•†å“åŒæœŸå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "è©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
