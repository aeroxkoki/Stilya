name: Daily Product Sync - Unified

on:
  schedule:
    # æ¯Žæ—¥åˆå‰2æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 17 * * *'  # UTC 17:00 = JST 2:00
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      sync_mode:
        description: 'Sync mode'
        required: false
        default: 'progressive'
        type: choice
        options:
          - progressive  # æ®µéšŽçš„å¢—åŠ ï¼ˆæŽ¨å¥¨ï¼‰
          - initial      # åˆæœŸåŒæœŸï¼ˆå°‘ãªã‚ï¼‰
          - full         # ãƒ•ãƒ«åŒæœŸï¼ˆæœ€å¤§ï¼‰
      priority_filter:
        description: 'Priority filter (1-7, or all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - '1'    # ãƒ¡ã‚¬ãƒ–ãƒ©ãƒ³ãƒ‰
          - '2'    # å¤§æ‰‹ECãƒ–ãƒ©ãƒ³ãƒ‰
          - '3'    # ã‚»ãƒ¬ã‚¯ãƒˆã‚·ãƒ§ãƒƒãƒ—
          - '4'    # ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«
          - '5'    # ãƒˆãƒ¬ãƒ³ãƒ‰
          - '6'    # ãƒ‹ãƒƒãƒ
      maintenance:
        description: 'Run maintenance tasks'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  sync-products:
    name: Daily Product Sync
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2æ™‚é–“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    
    steps:
    - name: ðŸ“¦ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ðŸ“¥ Install dependencies
      run: |
        npm ci
        npm install --save-prod dotenv @supabase/supabase-js axios
    
    - name: ðŸ” Environment check
      run: |
        echo "## ðŸ” Environment Check" >> $GITHUB_STEP_SUMMARY
        echo "- Date: $(date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
        echo "- Sync mode: ${{ github.event.inputs.sync_mode || 'progressive' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Priority filter: ${{ github.event.inputs.priority_filter || 'all' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Maintenance: ${{ github.event.inputs.maintenance || 'true' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # å¿…é ˆç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
        if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
          echo "âŒ SUPABASE_URL is not set" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        
        if [ -z "${{ secrets.RAKUTEN_APP_ID }}" ]; then
          echo "âŒ RAKUTEN_APP_ID is not set" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        
        echo "âœ… All required environment variables are set" >> $GITHUB_STEP_SUMMARY
    
    - name: ðŸ—„ï¸ Database capacity check
      id: capacity_check
      run: |
        echo "## ðŸ—„ï¸ Database Capacity" >> $GITHUB_STEP_SUMMARY
        
        # Supabaseã®å®¹é‡ãƒã‚§ãƒƒã‚¯ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
        cat > check-capacity.js << 'EOF'
        const { createClient } = require('@supabase/supabase-js');
        require('dotenv').config();
        
        const supabase = createClient(
          process.env.EXPO_PUBLIC_SUPABASE_URL,
          process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY
        );
        
        async function check() {
          const { count: total } = await supabase
            .from('external_products')
            .select('*', { count: 'exact', head: true });
            
          const { count: active } = await supabase
            .from('external_products')
            .select('*', { count: 'exact', head: true })
            .eq('is_active', true);
            
          console.log(`- Total products: ${total?.toLocaleString() || 0}`);
          console.log(`- Active products: ${active?.toLocaleString() || 0}`);
          console.log(`- Target products: 50,000+`);
          
          if (total > 90000) {
            console.error('âš ï¸ WARNING: Database is near capacity limit!');
            process.exit(1);
          }
        }
        
        check().catch(console.error);
        EOF
        
        node check-capacity.js >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ Capacity check failed" >> $GITHUB_STEP_SUMMARY
      env:
        EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    - name: ðŸŽ¯ Run product sync
      id: sync
      run: |
        echo "## ðŸŽ¯ Product Sync (50,000+ products target)" >> $GITHUB_STEP_SUMMARY
        
        # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
        export PRIORITY_FILTER="${{ github.event.inputs.priority_filter || 'all' }}"
        export SYNC_MODE="${{ github.event.inputs.sync_mode || 'progressive' }}"
        
        # åŒæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œï¼ˆå¤§è¦æ¨¡ç‰ˆï¼‰
        node scripts/sync-extended-mvp-brands.js
      env:
        EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        RAKUTEN_APP_ID: ${{ secrets.RAKUTEN_APP_ID }}
        RAKUTEN_AFFILIATE_ID: ${{ secrets.RAKUTEN_AFFILIATE_ID }}
        NODE_ENV: production
      continue-on-error: true
    
    - name: ðŸ§¹ Database maintenance
      if: github.event.inputs.maintenance != 'false' && steps.sync.outcome == 'success'
      run: |
        echo "## ðŸ§¹ Maintenance Tasks" >> $GITHUB_STEP_SUMMARY
        
        # ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
        cat > maintenance.js << 'EOF'
        const { createClient } = require('@supabase/supabase-js');
        require('dotenv').config();
        
        const supabase = createClient(
          process.env.EXPO_PUBLIC_SUPABASE_URL,
          process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY
        );
        
        async function maintenance() {
          // 30æ—¥ä»¥ä¸Šå¤ã„éžã‚¢ã‚¯ãƒ†ã‚£ãƒ–å•†å“ã‚’å‰Šé™¤
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
          
          const { data, error } = await supabase
            .from('external_products')
            .delete()
            .eq('is_active', false)
            .lt('last_synced', thirtyDaysAgo.toISOString())
            .limit(1000);
            
          if (!error && data) {
            console.log(`- Deleted ${data.length} old inactive products`);
          }
          
          // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
          const { count: total } = await supabase
            .from('external_products')
            .select('*', { count: 'exact', head: true });
            
          const { count: active } = await supabase
            .from('external_products')
            .select('*', { count: 'exact', head: true })
            .eq('is_active', true);
            
          console.log(`- After maintenance: ${active?.toLocaleString() || 0} active / ${total?.toLocaleString() || 0} total`);
        }
        
        maintenance().catch(console.error);
        EOF
        
        node maintenance.js >> $GITHUB_STEP_SUMMARY || echo "- Maintenance failed" >> $GITHUB_STEP_SUMMARY
      env:
        EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    - name: ðŸ“Š Generate final report
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š Sync Report Summary" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.sync.outcome }}" == "success" ]; then
          echo "### âœ… Sync Status: Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target**: 50,000+ products across 40+ brands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Major Brand Categories:" >> $GITHUB_STEP_SUMMARY
          echo "- **Mega Brands**: UNIQLO (8,000), GU (8,000), ç„¡å°è‰¯å“ (5,000)" >> $GITHUB_STEP_SUMMARY
          echo "- **Marketplace**: æ¥½å¤©ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ç·åˆ (10,000)" >> $GITHUB_STEP_SUMMARY
          echo "- **Category Search**: ãƒˆãƒƒãƒ—ã‚¹, ãƒœãƒˆãƒ ã‚¹, ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹ (å„5,000)" >> $GITHUB_STEP_SUMMARY
          echo "- **EC Brands**: coca, pierrot, Re:EDIT, fifth, titivate" >> $GITHUB_STEP_SUMMARY
          echo "- **Select Shops**: URBAN RESEARCH, BEAMS, SHIPS, etc." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Features:" >> $GITHUB_STEP_SUMMARY
          echo "- Intelligent rotation system" >> $GITHUB_STEP_SUMMARY
          echo "- Machine learning-based tagging (30 tags per product)" >> $GITHUB_STEP_SUMMARY
          echo "- Seasonal prioritization" >> $GITHUB_STEP_SUMMARY
          echo "- Automatic cleanup of old products" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Sync Status: Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs for details." >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ðŸ’¾ Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sync-logs-${{ github.run_id }}
        path: |
          logs/
          data/sync-history.json
          *.log
        retention-days: 7
        if-no-files-found: ignore
    
    - name: ðŸŽ‰ Success notification
      if: success()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ‰ Daily Product Sync Completed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "Working towards 50,000+ products to provide the best fashion recommendations!" >> $GITHUB_STEP_SUMMARY
