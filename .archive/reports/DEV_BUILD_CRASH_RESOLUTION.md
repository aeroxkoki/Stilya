# Expo SDK 53 開発ビルドクラッシュ問題 - 診断と解決レポート

## 問題の概要
- **症状**: QRコード読み取り後、開発ビルドアプリがクラッシュする
- **環境**: Expo SDK 53.0.9, React Native 0.79.2, React 19.0.0
- **プラットフォーム**: iOS/Android開発ビルド

## 根本原因の分析

### 1. Metro設定の問題
- `blacklistRE`が非推奨のプロパティを使用していた
- キャッシュ管理が不適切だった
- 開発ビルド用の設定が不足していた

### 2. ネットワーク設定の問題
- Expo SDK 53では、LANモードでの接続に問題があることが判明
- デバイスとコンピューターが同じネットワーク上にあってもクラッシュが発生
- IPv4アドレスの設定が必要

### 3. 初期化タイミングの問題
- アプリの初期化時に重い処理が同時実行されていた
- Supabaseリスナー、オフラインデータクリーンアップ、画像キャッシュクリアが同時に実行

### 4. New Architectureの設定
- SDK 53ではデフォルトで有効になるが、プロジェクトでは無効化設定
- これにより互換性の問題が発生する可能性

## 実施した解決策

### 1. Metro Configの更新
```javascript
// 非推奨のblacklistREをblockListに変更
// キャッシュストアの設定を追加
// 開発ビルド用のサーバー設定を追加
```

### 2. app.config.jsの更新
```javascript
// Hermesエンジンの明示的な有効化
// パッケージャーオプションの追加
```

### 3. App.tsxの改善
```javascript
// 開発ビルドの検出ロジックを追加
// 初期化処理の遅延実行
// エラーハンドリングの強化
// ローディング画面の追加
```

### 4. 新しいスクリプトの追加
- `npm run init-dev`: 開発ビルドの初期化
- `npm run start:tunnel`: Tunnelモードで起動
- `npm run start:lan`: LANモードで起動
- `npm run doctor`: Expo Doctorの実行

## 推奨される起動手順

### 初回セットアップ
```bash
# 1. 開発ビルドの初期化
npm run init-dev

# 2. 環境変数の確認
npm run check-env

# 3. 診断の実行
npm run doctor
```

### 通常の起動
```bash
# LANモードで起動（推奨）
npm run start:lan

# LANモードで失敗する場合、Tunnelモードを使用
npm run start:tunnel
```

### トラブルシューティング
```bash
# キャッシュのクリア
npm run clear-cache

# 完全リセット
npm run full-reset
```

## 追加の推奨事項

### 1. ネットワーク設定
- ファイアウォールでポート8081が開いていることを確認
- VPNを使用している場合は無効化
- 同じWi-Fiネットワークに接続していることを確認

### 2. 開発環境
- Node.js 20.18.1を使用（eas.jsonで指定済み）
- Watchmanがインストールされていることを確認（macOS）
- Xcodeが最新版であることを確認（iOS開発の場合）

### 3. デバイス設定
- 開発者モードが有効になっていることを確認
- USBデバッグが有効になっていることを確認（Android）
- デバイスが信頼されていることを確認（iOS）

## 今後の対応

### 短期的対応
1. 現在の設定で開発ビルドをテスト
2. 問題が解決しない場合、追加のデバッグログを収集
3. 必要に応じてExpo SDK 53の既知の問題を追跡

### 長期的対応
1. New Architectureへの移行を検討
2. Expo SDK 54のリリース時に更新を検討
3. パフォーマンス最適化の継続

## 結論
Expo SDK 53での開発ビルドクラッシュ問題は、主にMetro設定とネットワーク設定の問題が原因でした。上記の解決策を実装することで、安定した開発環境を構築できます。

問題が継続する場合は、`npm run start:tunnel`を使用してTunnelモードで開発を進めることを推奨します。

最終更新日: 2025年7月23日
